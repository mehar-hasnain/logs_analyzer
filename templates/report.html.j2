<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calo Balance Log Analytics â€” Report</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1, h2 { margin: 0.4em 0; }
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .card { background: #fafafa; padding: 16px; border-radius: 12px; border: 1px solid #eee; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; font-size: 14px; }
    code { background: #f0f0f0; padding: 2px 6px; border-radius: 4px; }
    .section { margin-top: 28px; }
  </style>
</head>
<body>
  <h1>Calo Balance Log Analytics</h1>
  <div class="cards">
    <div class="card"><b>Total transactions</b><div style="font-size: 28px">{{ totals.transactions }}</div></div>
    <div class="card"><b>Unique users</b><div style="font-size: 28px">{{ totals.unique_users }}</div></div>
    <div class="card"><b>Total debit</b><div style="font-size: 24px">{{ '%.2f' % totals.total_debit }}</div></div>
    <div class="card"><b>Total credit</b><div style="font-size: 24px">{{ '%.2f' % totals.total_credit }}</div></div>
  </div>

  <div class="section">
    <h2>Charts</h2>
    {{ fig1|safe }}
    {{ fig2|safe }}
    {{ fig3|safe }}
  </div>

  <div class="section">
    <h2>Top Issues</h2>
    <h3>Overdrafts (Top 10)</h3>
    <table>
      <thead><tr><th>Timestamp</th><th>User</th><th>Tx ID</th><th>Amount</th><th>Old Balance</th><th>Overdraft</th></tr></thead>
      <tbody>
      {% for r in top_overdrafts %}
        <tr><td>{{ r.timestamp }}</td><td><code>{{ r.userId }}</code></td><td><code>{{ r.id }}</code></td><td>{{ r.amount }}</td><td>{{ r.oldBalance }}</td><td>{{ r.newBalance }}</td></tr>
      {% endfor %}
      </tbody>
    </table>
   {% if top_mismatches %}
    <h3>Mismatched Balances (sample)</h3>
    <table>
      <thead><tr><th>Timestamp</th><th>User</th><th>Tx ID</th><th>Old</th><th>Amount</th><th>Expected New</th><th>Actual New</th><th>Suggested Adjustment</th></tr></thead>
      <tbody>
      {% for r in top_mismatches %}
        <tr><td>{{ r.timestamp }}</td><td><code>{{ r.userId }}</code></td><td><code>{{ r.id }}</code></td><td>{{ r.oldBalance }}</td><td>{{ r.amount }}</td><td>{{ r.expectedNewBalance }}</td><td>{{ r.newBalance }}</td><td>{{ r.suggestedAdjustment }}</td></tr>
      {% endfor %}
      </tbody>
    </table>
   {% endif %}

    <h3>Anomalies (sample)</h3>
    <table>
      <thead><tr><th>Timestamp</th><th>User</th><th>Tx ID</th><th>Type</th><th>Source</th><th>Action</th><th>Amount</th><th>Old Balance</th><th>New Balance</th><th>Flags</th><th>Description</th></tr></thead>
      <tbody>
      {% for a in anomalies %}
        <tr>
          <td>{{ a.timestamp }}</td>
          <td><code>{{ a.userId }}</code></td>
          <td><code>{{ a.id }}</code></td>
          <td>{{ a.type }}</td>
          <td>{{ a.source }}</td>
          <td>{{ a.action }}</td>
          <td>{{ a.amount }}</td>
          <td>{{ a.oldBalance }}</td>
          <td>{{ a.newBalance }}</td>
          <td>{{ a.anomalyType }}</td>
          <td>{{ a.details }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <p style="margin-top: 24px; color: #666">Generated by Calo Balance Log Analytics.</p>
</body>
</html>